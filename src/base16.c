#include "base32.h"

static const char basis16[] =
	"0123456789ABCDEF";

static const unsigned char b16_to_five[] = {
/*       0   1   2   3   4   5   6   7   8   9  10  11  12  13  14  15*/
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 16, 16, 16,  0, 16, 16,
	16, 10, 11, 12, 13, 14, 15, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
	16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16,
};

size_t Base16Encode_size(size_t len)
{
	return (len * 2) + 1;
}

size_t Base16Encode(char * encoded, const char * string, size_t len)
{
	/* Map
	* xxxxxxxx
	* ----
	*     ----
	*  0    1
	*/
	char *p = encoded;
	size_t i;
	if (len != 0) {
		for (i = 0; i < len; i+= 1) {
			/* 0 */	*p++ = basis16[(int)((string[i] >> 4) & 0xF)];
			/* 1 */	*p++ = basis16[(int)(string[i] & 0xF)];
		}
	}

	*p++ = '\0';
	return p - encoded;
}

size_t Base16Decode_size(size_t size)
{
	return ((size + 1) / 2) + 1;
}

size_t Base16Decode(char * string, const char * encoded, size_t len)
{
	/* Map
	* xxxxxxxx
	* ----
	*     ----
	*  0    1
	*/
	char *p = string;
	char a, b;
	for (size_t i = 0; i < len; i+= 2) {
		a = b16_to_five[(int)encoded[i]];
		b = b16_to_five[(int)encoded[i+1]];
		if (a >= 16 || b >= 16)
			return 0;

		*p++ = (a << 4) | b;
	}

	*p++ = '\0';
	return p - string;
}
